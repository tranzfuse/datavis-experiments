<html>
  <head>
    <meta charset="utf-8">
    <title>D3 Experiment</title>
    <style>
      body {
        font-family: verdana, sans-serif;
        font-size: 11px;
      }

      svg {
        border-bottom: 1px solid #000;
        border-left: 1px solid #000;
      }

      #years {
        margin: 0;
        padding: 0;
        position: relative;
      }

      li {
        list-style: none;
        position: absolute;
      }
    </style>
    <script src="../js/vendor/d3.min.js"></script>
  </head>
  <body>
    <div id="release-years"></div>

    <script>
      (function() {
        'use strict';

        var svg,
          svgW = 980,
          svgH = 250;

        var discogsData, releases, years, yearAggregate, yearAggLen;

        var bars,
          barMargin = 5,
          barHeightMultiplier = 10;

        var labels;

        var yearsList, yearsListItems;

        svg = d3.select('#release-years')
          .append('svg')
          .attr('width', svgW)
          .attr('height', svgH);

        d3.json('discogs_collection_pg1.json', function(data) {
          discogsData = data;
          releases = discogsData.releases;
          yearAggregate = aggregateReleaseYears(releases);
          yearAggLen = yearAggregate.length;

          bars = svg.selectAll('rect')
          .data(yearAggregate)
          .enter()
          .append('rect');

          bars.attr('fill', 'teal')
          .attr('width', svgW / yearAggLen - barMargin)
          .attr('height', function(d) {
            var height = d.count * barHeightMultiplier;
            return height;
          })
          .attr('x', function(d, i) {
            return i * (svgW / yearAggLen);
          })
          .attr('y', function(d, i) {
            return svgH - d.count * barHeightMultiplier;
          });

          labels = svg.selectAll('text')
            .data(yearAggregate)
            .enter()
            .append('text')
            .text(function(d) {
              return d.count;
            })
            .attr('x', function(d, i) {
              return i * (svgW / yearAggLen) + (svgW / yearAggLen - this.getComputedTextLength()) / 2;
            })
            .attr('y', function(d, i) {
              return svgH - d.count * barHeightMultiplier + 15; //15 is arbitrary, just nudging the label text a bit.
            })
            .attr('fill', 'white');

          yearsList = d3.select('#release-years')
            .append('ul')
            .attr('id', 'years');

          yearsListItems = yearsList.selectAll('li')
            .data(yearAggregate)
            .enter()
            .append('li')
            .text(function(d) {
              return d.year;
            })
            .style('left', function(d, i) {
              console.log(this);
              return i * (svgW / yearAggLen) + 'px';
            })

        });


        function aggregateReleaseYears(data) {
          var summed = {},
            results = [],
            years = [];

          //extract the release years into an array
          data.forEach(function(el, i, arr) {
            years.push(el.basic_information.year);
          });

          //sum number of times each year occurs and store in results object
          years.map(function(year) {
            if (year in summed) {
              summed[year]++;
            } else {
              summed[year] = 1;
            }
          });

          //format data into array of objects
          for (var prop in summed) {
            var obj = {};
            obj.year = prop;
            obj.count = summed[prop];
            results.push(obj);
          }

          return results;
        }

      }());
    </script>
  </body>
</html>
