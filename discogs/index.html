<html>
  <head>
    <meta charset="utf-8">
    <title>D3 Experiment</title>
    <style>
      svg {
        border-bottom: 1px solid #000;
        border-left: 1px solid #000;
      }
    </style>
    <script src="../js/vendor/d3.min.js"></script>
  </head>
  <body>

    <script>
      'use strict';

      var discogsData, releases, years, yearAggregate, len;

      var svg,
        svgW = 750,
        svgH = 250;

      var bars,
        barMargin = 5,
        barHeightMultiplier = 10;

      var labels;

      d3.json('discogs_collection_pg1.json', function(data) {
        discogsData = data;
        releases = discogsData.releases;
        yearAggregate = aggregateReleaseYears(releases);
        len = yearAggregate.length;

        svg = d3.select('body')
        .append('svg')
        .attr('width', svgW)
        .attr('height', svgH);

        bars = svg.selectAll('rect')
        .data(yearAggregate)
        .enter()
        .append('rect');

        bars.attr('fill', 'teal')
        .attr('width', svgW / len - barMargin)
        .attr('height', function(d) {
          var height = d.count * barHeightMultiplier;
          return height;
        })
        .attr('x', function(d, i) {
          return i * (svgW / len);
        })
        .attr('y', function(d, i) {
          return svgH - d.count * barHeightMultiplier;
        });

        labels = svg.selectAll('text')
          .data(yearAggregate)
          .enter()
          .append('text')
          .text(function(d) {
            return d.year;
          })
          .attr('x', function(d, i) {
            return i * (svgW / len) + (svgW / len - this.getComputedTextLength()) / 2;
          })
          .attr('y', function(d, i) {
            return svgH - d.count * barHeightMultiplier + 15; //15 is arbitrary, just nudging the label text a bit.
          })
          .attr('font-family', 'sans-serif')
          .attr('font-size', '11px')
          .attr('fill', 'white');
      });

      function aggregateReleaseYears(data) {
        var summed = {},
          results = [],
          years = [];

        //extract the release years into an array
        data.forEach(function(el, i, arr) {
          years.push(el.basic_information.year);
        });

        //sum number of times each year occurs and store in results object
        years.map(function(year) {
          if (year in summed) {
            summed[year]++;
          } else {
            summed[year] = 1;
          }
        });

        //format data into array of objects
        for (var prop in summed) {
          var obj = {};
          obj.year = prop;
          obj.count = summed[prop];
          results.push(obj);
        }

        return results;
      }
    </script>
  </body>
</html>
