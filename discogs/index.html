<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>D3 Experiment</title>
    <link href="css/styles.css" rel="stylesheet" type="text/css" />
    <script src="../js/vendor/d3.min.js"></script>
  </head>
  <body>

    <svg class="chart"></svg>

    <script>
      (function() {

        'use strict';

        var width = 420,
          barHeight = 20;

        var discogsData, releases, years, yearAggregate, yearAggLen;

        var x = d3.scale.linear()
          .range([0, width]);

        var chart = d3.select('.chart')
          .attr('width', width)

        d3.json('discogs_collection_pg1.json', function(data) {
          discogsData = data;
          releases = discogsData.releases;
          yearAggregate = aggregateReleaseYears(releases);
          yearAggLen = yearAggregate.length;

          x.domain([0, d3.max(yearAggregate, function(d) {return d.count;})]);

          chart.attr('height', barHeight * yearAggLen);

          var bar = chart.selectAll('g')
            .data(yearAggregate)
            .enter()
            .append('g')
            .attr('transform', function(d, i) {
              return 'translate(0,' + i * barHeight + ')';
            });

          bar.append('rect')
            .attr('width', function(d) {return x(d.count);})
            .attr('height', barHeight - 1);

          bar.append('text')
            .attr('x', function(d) {
              return x(d.count) - 3;
            })
            .attr('y', barHeight / 2)
            .attr('dy', '.35em')
            .text(function(d) {
              return d.count;
            });
        });


        /**
         * rebuild formatted object from discogs json data source
         * @param {object} data the discogs json source
         * @returns {object}
         */
        function aggregateReleaseYears(data) {
          var summed = {},
            results = [],
            years = [];

          //extract the release years into an array
          data.forEach(function(el, i, arr) {
            years.push(el.basic_information.year);
          });

          //sum number of times each year occurs and store in results object
          years.map(function(year) {
            if (year in summed) {
              summed[year]++;
            } else {
              summed[year] = 1;
            }
          });

          //format data into array of objects
          for (var prop in summed) {
            var obj = {};
            obj.year = prop;
            obj.count = summed[prop];
            results.push(obj);
          }

          return results;
        }
      }());
    </script>
  </body>
</html>
